<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Meteran - Rusunawa Gunungsari</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <nav class="bg-blue-800 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <span class="text-xl font-bold">Input Pencatatan Air</span>
            <a href="laporan.html" class="text-sm bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded">Lihat Laporan</a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4">
        
        <div class="bg-white p-4 rounded-lg shadow mb-6 flex flex-col md:flex-row items-center gap-4">
            <label class="font-bold text-gray-700">Pilih Lantai:</label>
            <select id="pilihLantai" onchange="renderTabel()" class="border-2 border-blue-500 rounded p-2 w-full md:w-64 font-bold text-lg">
                <option value="SEMUA">-- Tampilkan Semua --</option>
                <option value="1">Lantai 1 (Unit A1xx)</option>
                <option value="2">Lantai 2 (Unit A2xx / C2xx)</option>
                <option value="3">Lantai 3 (Unit A3xx / C3xx)</option>
                <option value="4">Lantai 4 (Unit A4xx / C4xx)</option>
                <option value="5">Lantai 5 (Unit A5xx / C5xx)</option>
            </select>
            <div class="text-sm text-gray-500 ml-auto">
                *Otomatis menampilkan Meteran Terakhir (Desember)
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 text-sm uppercase font-bold">
                            <th class="p-3 border">Unit</th>
                            <th class="p-3 border">Nama Penghuni</th>
                            <th class="p-3 border text-center bg-yellow-50">Meter Lalu</th>
                            <th class="p-3 border text-center bg-blue-50">Meter Sekarang (Jan)</th>
                            <th class="p-3 border text-right">Estimasi Tagihan</th>
                        </tr>
                    </thead>
                    <tbody id="tabelInput">
                        <tr><td colspan="5" class="p-8 text-center">Memuat data unit & meteran terakhir...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="fixed bottom-6 right-6">
            <button onclick="simpanSemua()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-full shadow-2xl flex items-center gap-2 transform transition hover:scale-105">
                ðŸ’¾ SIMPAN DATA JANUARI
            </button>
        </div>

    </div>

    <script>
        // --- KONFIGURASI SUPABASE (SAMA SEPERTI SEBELUMNYA) ---
        const SUPABASE_URL = 'https://mxtizprwaflafsejlrlw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_zfDUciq56k8zvSVc-Uw_7g_IIvrJMAQ';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let globalDataUnits = [];
        let globalDataMeter = {};

        // 1. Ambil Data Unit & Meteran Terakhir saat Web Dibuka
        async function inisialisasi() {
            // Ambil Daftar Penghuni (Master)
            const { data: units, error: errUnit } = await _supabase
                .from('data_penghuni')
                .select('*')
                .order('no_unit', { ascending: true });

            // Ambil Pencatatan Terakhir (Untuk cari meteran Desember/Lalu)
            // Trik: Kita ambil semua, nanti di JS kita filter yang paling baru per unit
            const { data: logs, error: errLog } = await _supabase
                .from('pencatatan_air')
                .select('no_unit, meter_sekarang, created_at')
                .order('created_at', { ascending: false });

            if (errUnit) { alert("Gagal ambil data unit"); return; }

            globalDataUnits = units;

            // Proses Mapping Meteran Terakhir
            if (logs) {
                logs.forEach(log => {
                    // Karena sudah di-order descending (terbaru diatas), 
                    // jika unit belum ada di map, berarti ini yang paling baru
                    if (!globalDataMeter[log.no_unit]) {
                        globalDataMeter[log.no_unit] = log.meter_sekarang;
                    }
                });
            }

            renderTabel();
        }

        // 2. Tampilkan Tabel sesuai Filter Lantai
        function renderTabel() {
            const filter = document.getElementById('pilihLantai').value;
            const tbody = document.getElementById('tabelInput');
            tbody.innerHTML = '';

            let jumlahBaris = 0;

            globalDataUnits.forEach((unit, index) => {
                // Logika Filter Lantai Sederhana (Cek angka lantai di dalam string unit)
                // Contoh: A.1.01 mengandung "1", A.2.01 mengandung "2"
                // Kita asumsi format unit mengandung angka lantai.
                let tampil = false;
                if (filter === 'SEMUA') tampil = true;
                else {
                    // Cek apakah no_unit mengandung angka lantai (misal "1" untuk lantai 1)
                    // Tapi hati-hati A.1.12 (lantai 1) mengandung angka 1 dan 2.
                    // Cara aman: Cek karakter kedua/ketiga atau prefix
                    // Asumsi User: A.1.xx atau A1xx
                    if (unit.no_unit.includes(filter)) tampil = true; 
                    // Jika unit formatnya A.1.01, filter '1' akan ketemu.
                }

                if (tampil) {
                    jumlahBaris++;
                    const meterLalu = globalDataMeter[unit.no_unit] || 0; // Kalau data baru, 0
                    
                    const row = `
                        <tr class="hover:bg-gray-50 border-b">
                            <td class="p-3 font-bold text-gray-800">${unit.no_unit}</td>
                            <td class="p-3 text-sm text-gray-600">${unit.nama_penghuni || '-'}</td>
                            <td class="p-3 bg-yellow-50 text-center font-mono">
                                <input type="number" id="lalu-${index}" value="${meterLalu}" readonly 
                                    class="w-20 text-center bg-transparent border-none text-gray-500 select-none">
                            </td>
                            <td class="p-3 bg-blue-50 text-center">
                                <input type="number" id="kini-${index}" 
                                    oninput="hitungBaris(${index})" placeholder="..."
                                    class="w-24 text-center p-2 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 font-bold text-lg text-blue-900">
                            </td>
                            <td class="p-3 text-right font-medium text-green-700" id="biaya-${index}">
                                Rp 0
                            </td>
                            <input type="hidden" id="nounit-${index}" value="${unit.no_unit}">
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });

            if(jumlahBaris === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">Tidak ada unit ditemukan untuk lantai ini.</td></tr>`;
            }
        }

        // 3. Hitung Otomatis Saat Ngetik (Live Calculator)
        function hitungBaris(index) {
            const lalu = parseFloat(document.getElementById(`lalu-${index}`).value) || 0;
            const kini = parseFloat(document.getElementById(`kini-${index}`).value);
            const displayBiaya = document.getElementById(`biaya-${index}`);

            if (isNaN(kini)) {
                displayBiaya.innerText = "Rp 0";
                return;
            }

            let pakai = kini - lalu;
            if (pakai < 0) pakai = 0; // Tidak boleh minus

            // RUMUS TARIF
            let tagihanAir = 0;
            if (pakai <= 10) {
                tagihanAir = 25000;
            } else {
                tagihanAir = pakai * 2500;
            }
            let total = tagihanAir + 10000; // Sampah

            displayBiaya.innerText = "Rp " + total.toLocaleString('id-ID');
        }

        // 4. Proses Simpan ke Database
        async function simpanSemua() {
            const inputs = document.querySelectorAll('input[id^="kini-"]');
            let dataUpload = [];
            let terisi = 0;

            // Loop semua input yang ada isinya
            inputs.forEach(input => {
                if (input.value !== "") {
                    const idx = input.id.split('-')[1];
                    const no_unit = document.getElementById(`nounit-${idx}`).value;
                    const meter_lalu = parseFloat(document.getElementById(`lalu-${idx}`).value);
                    const meter_sekarang = parseFloat(input.value);
                    
                    // Hitung Ulang untuk Data Final
                    let pakai = meter_sekarang - meter_lalu;
                    if(pakai < 0) pakai = 0;
                    let tagihan_air = (pakai <= 10) ? 25000 : (pakai * 2500);
                    let total_bayar = tagihan_air + 10000;

                    // Siapkan Object Data
                    dataUpload.push({
                        no_unit: no_unit,
                        meter_lalu: meter_lalu,
                        meter_sekarang: meter_sekarang,
                        tagihan_air: tagihan_air,
                        total_bayar: total_bayar,
                        created_at: new Date().toISOString() // Tanggal HARI INI (Januari)
                    });
                    terisi++;
                }
            });

            if (terisi === 0) {
                Swal.fire('Belum ada data', 'Silakan isi angka meteran minimal satu unit.', 'warning');
                return;
            }

            // Tampilkan Loading
            Swal.fire({title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

            // Kirim ke Supabase
            const { error } = await _supabase.from('pencatatan_air').insert(dataUpload);

            if (error) {
                Swal.fire('Gagal!', error.message, 'error');
            } else {
                Swal.fire('Berhasil!', `Data ${terisi} unit berhasil disimpan.`, 'success')
                .then(() => location.reload()); // Refresh halaman
            }
        }

        // Jalankan
        inisialisasi();
    </script>
</body>
</html>
